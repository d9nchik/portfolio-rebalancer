<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Portfolio Rebalancer</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,400;0,500;0,700&family=JetBrains+Mono:wght@400;500;600;700&display=swap');

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg: #0a0c10;
    --surface: #12151c;
    --surface-2: #1a1e28;
    --surface-3: #222735;
    --border: #2a3040;
    --border-focus: #4a8cff;
    --text: #e4e8f0;
    --text-dim: #8892a6;
    --text-muted: #5a6478;
    --accent: #4a8cff;
    --accent-dim: rgba(74, 140, 255, 0.12);
    --green: #34d399;
    --green-dim: rgba(52, 211, 153, 0.12);
    --red: #f87171;
    --red-dim: rgba(248, 113, 113, 0.12);
    --amber: #fbbf24;
    --amber-dim: rgba(251, 191, 36, 0.12);
    --chart-1: #4a8cff;
    --chart-2: #34d399;
    --chart-3: #a78bfa;
    --chart-4: #fbbf24;
    --chart-5: #f87171;
    --font-body: 'DM Sans', -apple-system, sans-serif;
    --font-mono: 'JetBrains Mono', 'SF Mono', monospace;
    --radius: 8px;
  }

  html { font-size: 15px; }

  body {
    font-family: var(--font-body);
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    line-height: 1.5;
    -webkit-font-smoothing: antialiased;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(74, 140, 255, 0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(74, 140, 255, 0.03) 1px, transparent 1px);
    background-size: 60px 60px;
    pointer-events: none;
    z-index: 0;
  }

  .app {
    position: relative;
    z-index: 1;
    max-width: 1080px;
    margin: 0 auto;
    padding: 2.5rem 1.5rem 4rem;
  }

  /* Header */
  header {
    margin-bottom: 2.5rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 0.75rem;
  }

  header h1 {
    font-family: var(--font-mono);
    font-size: 1.5rem;
    font-weight: 700;
    letter-spacing: -0.02em;
    color: var(--text);
  }

  header h1 span { color: var(--accent); }

  header p {
    margin-top: 0.35rem;
    font-size: 0.85rem;
    color: var(--text-muted);
    letter-spacing: 0.03em;
    text-transform: uppercase;
  }

  .header-actions {
    display: flex;
    gap: 0.5rem;
    flex-shrink: 0;
  }

  /* Buttons */
  .btn {
    font-family: var(--font-mono);
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    padding: 0.45rem 0.75rem;
    border-radius: var(--radius);
    border: 1px solid var(--border);
    background: var(--surface-2);
    color: var(--text-dim);
    cursor: pointer;
    transition: all 0.15s;
    white-space: nowrap;
  }

  .btn:hover {
    background: var(--surface-3);
    color: var(--text);
    border-color: var(--accent);
  }

  .btn-accent {
    background: var(--accent-dim);
    color: var(--accent);
    border-color: transparent;
  }

  .btn-accent:hover {
    background: var(--accent);
    color: var(--bg);
  }

  /* Sections */
  .section { margin-bottom: 2rem; }

  .section-label {
    font-family: var(--font-mono);
    font-size: 0.7rem;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin-bottom: 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .section-label::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border);
  }

  .section-label .btn {
    font-size: 0.6rem;
    padding: 0.25rem 0.5rem;
  }

  .section-label .timestamp {
    font-size: 0.6rem;
    font-weight: 400;
    color: var(--text-muted);
    opacity: 0.7;
  }

  /* Grid layouts */
  .grid-2 {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.25rem;
  }

  @media (max-width: 720px) {
    .grid-2 { grid-template-columns: 1fr; }
  }

  /* Cards */
  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
  }

  .card.scrollable {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }

  /* Tables */
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.87rem;
    min-width: 400px;
  }

  .compact-table table { min-width: 0; }

  thead th {
    font-family: var(--font-mono);
    font-size: 0.65rem;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.08em;
    padding: 0.7rem 0.85rem;
    text-align: left;
    background: var(--surface-2);
    border-bottom: 1px solid var(--border);
  }

  thead th:not(:first-child) { text-align: right; }

  tbody td {
    padding: 0 0.85rem;
    border-bottom: 1px solid var(--border);
    height: 44px;
    vertical-align: middle;
  }

  tbody td:not(:first-child) { text-align: right; }

  tbody tr:last-child td { border-bottom: none; }

  /* Ticker badge */
  .ticker {
    font-family: var(--font-mono);
    font-weight: 600;
    font-size: 0.85rem;
    color: var(--accent);
    letter-spacing: 0.02em;
  }

  .currency-badge {
    font-family: var(--font-mono);
    font-size: 0.72rem;
    font-weight: 500;
    color: var(--text-dim);
    background: var(--surface-3);
    padding: 0.15rem 0.45rem;
    border-radius: 4px;
    display: inline-block;
  }

  /* Inputs */
  input[type="number"], input[type="text"], select {
    font-family: var(--font-mono);
    font-size: 16px; /* prevent iOS zoom */
    color: var(--text);
    background: transparent;
    border: none;
    outline: none;
    width: 100%;
    padding: 0;
    text-align: inherit;
    -moz-appearance: textfield;
  }

  input[type="number"]::-webkit-inner-spin-button,
  input[type="number"]::-webkit-outer-spin-button {
    -webkit-appearance: none;
  }

  select {
    cursor: pointer;
    -webkit-appearance: none;
    appearance: none;
  }

  td.editable {
    position: relative;
    transition: background 0.15s;
  }

  td.editable::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0.85rem;
    right: 0.85rem;
    height: 1px;
    background: var(--border);
    opacity: 0;
    transition: opacity 0.15s;
  }

  td.editable:focus-within { background: var(--accent-dim); }
  td.editable:focus-within::after { background: var(--accent); opacity: 1; }

  /* Mono numbers */
  .mono {
    font-family: var(--font-mono);
    font-weight: 500;
    font-size: 0.85rem;
    font-variant-numeric: tabular-nums;
  }

  /* Big stat */
  .stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 1.25rem;
  }

  .stat-label {
    font-family: var(--font-mono);
    font-size: 0.65rem;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin-bottom: 0.5rem;
  }

  .stat-value {
    font-family: var(--font-mono);
    font-size: 1.8rem;
    font-weight: 700;
    color: var(--text);
    letter-spacing: -0.03em;
    line-height: 1.1;
  }

  .stat-value .dollar { color: var(--text-muted); font-weight: 500; }

  /* Rebalance advice */
  .advice-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.85rem;
    border-bottom: 1px solid var(--border);
    gap: 1rem;
    transition: background 0.15s;
  }

  .advice-row:last-child { border-bottom: none; }
  .advice-row.buy-row { background: var(--green-dim); }
  .advice-row.sell-row { background: var(--red-dim); }

  .advice-action {
    font-family: var(--font-mono);
    font-size: 0.72rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    padding: 0.2rem 0.55rem;
    border-radius: 4px;
    flex-shrink: 0;
  }

  .advice-action.buy { color: var(--green); background: var(--green-dim); }
  .advice-action.sell { color: var(--red); background: var(--red-dim); }
  .advice-action.balanced { color: var(--amber); background: var(--amber-dim); }

  .advice-detail {
    font-family: var(--font-mono);
    font-size: 0.82rem;
    color: var(--text-dim);
    flex: 1;
    text-align: right;
  }

  .advice-detail strong { color: var(--text); font-weight: 600; }

  /* Validation error */
  .validation-error {
    font-family: var(--font-mono);
    font-size: 0.78rem;
    color: var(--red);
    background: var(--red-dim);
    padding: 0.6rem 0.85rem;
    border-radius: var(--radius);
    margin-bottom: 1rem;
    display: none;
  }

  .validation-error.visible { display: block; }

  /* Percent bar */
  .pct-cell { position: relative; }

  .pct-bar {
    position: absolute;
    left: 0; top: 0; bottom: 0;
    background: var(--accent-dim);
    border-right: 2px solid var(--accent);
    transition: width 0.3s ease;
    pointer-events: none;
  }

  .pct-text {
    position: relative;
    z-index: 1;
  }

  .pct-over { color: var(--red); }
  .pct-under { color: var(--green); }

  /* Donut charts */
  .charts-row {
    display: flex;
    gap: 2rem;
    justify-content: center;
    align-items: center;
    flex-wrap: wrap;
    margin-bottom: 1.5rem;
  }

  .chart-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.75rem;
  }

  .chart-title {
    font-family: var(--font-mono);
    font-size: 0.65rem;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.1em;
  }

  .donut {
    width: 140px;
    height: 140px;
    border-radius: 50%;
    position: relative;
  }

  .donut::after {
    content: '';
    position: absolute;
    inset: 30px;
    border-radius: 50%;
    background: var(--bg);
  }

  .chart-legend {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
    justify-content: center;
  }

  .legend-item {
    display: flex;
    align-items: center;
    gap: 0.35rem;
    font-family: var(--font-mono);
    font-size: 0.7rem;
    color: var(--text-dim);
  }

  .legend-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  /* Toast notification */
  .toast {
    position: fixed;
    bottom: 2rem;
    left: 50%;
    transform: translateX(-50%) translateY(100px);
    font-family: var(--font-mono);
    font-size: 0.78rem;
    background: var(--surface-3);
    color: var(--text);
    border: 1px solid var(--border);
    padding: 0.6rem 1.2rem;
    border-radius: var(--radius);
    z-index: 100;
    opacity: 0;
    transition: transform 0.3s ease, opacity 0.3s ease;
    pointer-events: none;
  }

  .toast.visible {
    transform: translateX(-50%) translateY(0);
    opacity: 1;
  }

  /* Footer */
  footer {
    margin-top: 3rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--border);
    font-size: 0.75rem;
    color: var(--text-muted);
    text-align: center;
  }

  footer a { color: var(--accent); text-decoration: none; }

  /* Mobile */
  @media (max-width: 480px) {
    .app { padding: 1.5rem 1rem 3rem; }
    header h1 { font-size: 1.2rem; }
    .stat-value { font-size: 1.4rem; }
    .charts-row { gap: 1.5rem; }
    .donut { width: 110px; height: 110px; }
    .donut::after { inset: 24px; }
  }
</style>
</head>
<body>

<div class="app">
  <header>
    <div>
      <h1><span>//</span> Portfolio Rebalancer</h1>
      <p>Real-time allocation engine &mdash; data stored locally</p>
    </div>
    <div class="header-actions">
      <button class="btn" id="btn-export" title="Copy shareable link (without sensitive data)">Export</button>
      <button class="btn btn-accent" id="btn-import" title="Import config from URL" style="display:none">Import from URL</button>
    </div>
  </header>

  <div id="validation" class="validation-error"></div>

  <!-- INPUTS -->
  <div class="section">
    <div class="section-label">Assets</div>
    <div class="card scrollable">
      <table>
        <thead>
          <tr>
            <th>Ticker</th>
            <th>Split %</th>
            <th>Price ($)</th>
            <th>Ccy</th>
            <th>Holdings</th>
          </tr>
        </thead>
        <tbody id="assets-body"></tbody>
      </table>
    </div>
  </div>

  <div class="grid-2">
    <div class="section">
      <div class="section-label">
        Exchange Rates
        <button class="btn" id="btn-refresh-rates" title="Fetch latest from ECB">Refresh</button>
        <span class="timestamp" id="rates-timestamp"></span>
      </div>
      <div class="card compact-table">
        <table>
          <thead><tr><th>Currency</th><th>Rate to USD</th></tr></thead>
          <tbody id="rates-body"></tbody>
        </table>
      </div>
    </div>
    <div class="section">
      <div class="section-label">Liquidity</div>
      <div class="card compact-table">
        <table>
          <thead><tr><th>Currency</th><th>Amount ($)</th></tr></thead>
          <tbody id="liquidity-body"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- TOTAL -->
  <div class="section">
    <div class="stat-card">
      <div class="stat-label">Total Portfolio Value</div>
      <div class="stat-value"><span class="dollar">$</span><span id="total-value">0.00</span></div>
    </div>
  </div>

  <!-- DONUT CHARTS -->
  <div class="section">
    <div class="charts-row">
      <div class="chart-container">
        <div class="chart-title">Current Allocation</div>
        <div class="donut" id="donut-current"></div>
      </div>
      <div class="chart-container">
        <div class="chart-title">Target Allocation</div>
        <div class="donut" id="donut-target"></div>
      </div>
    </div>
    <div class="chart-legend" id="chart-legend"></div>
  </div>

  <!-- OUTPUTS -->
  <div class="grid-2">
    <div class="section">
      <div class="section-label">Target Allocation</div>
      <div class="card compact-table">
        <table>
          <thead><tr><th>Ticker</th><th>Value (USD)</th></tr></thead>
          <tbody id="target-body"></tbody>
        </table>
      </div>
    </div>
    <div class="section">
      <div class="section-label">Current Stock Values</div>
      <div class="card compact-table">
        <table>
          <thead><tr><th>Ticker</th><th>Value (USD)</th></tr></thead>
          <tbody id="stock-values-body"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="section">
    <div class="section-label">Liquidity Values</div>
    <div class="card compact-table">
      <table>
        <thead><tr><th>Currency</th><th>Value (USD)</th></tr></thead>
        <tbody id="liquidity-values-body"></tbody>
      </table>
    </div>
  </div>

  <div class="grid-2">
    <div class="section">
      <div class="section-label">% of Total Portfolio</div>
      <div class="card compact-table">
        <table>
          <thead><tr><th>Ticker</th><th>Weight</th></tr></thead>
          <tbody id="pct-total-body"></tbody>
        </table>
      </div>
    </div>
    <div class="section">
      <div class="section-label">% of Stock Portfolio</div>
      <div class="card compact-table">
        <table>
          <thead><tr><th>Ticker</th><th>Weight</th></tr></thead>
          <tbody id="pct-stock-body"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="section">
    <div class="section-label">Rebalancing Advice</div>
    <div class="card" id="advice-card"></div>
  </div>

  <footer>
    Data is stored in your browser's localStorage. Nothing leaves your device.
    <br><a href="https://github.com/d9nchik/portfolio-rebalancer">Source on GitHub</a>
  </footer>
</div>

<div class="toast" id="toast"></div>

<script>
  const CHART_COLORS = ['var(--chart-1)', 'var(--chart-2)', 'var(--chart-3)', 'var(--chart-4)', 'var(--chart-5)'];
  const CHART_RAW = ['#4a8cff', '#34d399', '#a78bfa', '#fbbf24', '#f87171'];
  const CURRENCY_SYMBOLS = { USD: '$', EUR: '€', GBP: '£', CHF: 'CHF', JPY: '¥' };

  // Default configuration — prices in dollars (not cents)
  const DEFAULT_ASSETS = [
    { ticker: 'CSPX', split: 60, price: 740.82, currency: 'USD' },
    { ticker: 'EMIM', split: 20, price: 40.64, currency: 'EUR' },
    { ticker: 'XUSE', split: 20, price: 6.69, currency: 'USD' },
  ];

  const DEFAULT_RATES = { USD: 1, EUR: 1.1822 };
  const CURRENCIES = ['USD', 'EUR'];

  // State
  let assets = DEFAULT_ASSETS.map(a => ({ ...a }));
  let rates = { ...DEFAULT_RATES };
  let stocks = {};
  let liquidity = {}; // stored in dollars

  // Toast
  function showToast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('visible');
    setTimeout(() => t.classList.remove('visible'), 2500);
  }

  // localStorage
  function loadState() {
    try {
      const s = JSON.parse(localStorage.getItem('stocks'));
      if (s && typeof s === 'object') stocks = s;
    } catch {}
    try {
      const l = JSON.parse(localStorage.getItem('liquidity'));
      if (l && typeof l === 'object') liquidity = l;
    } catch {}
  }

  function saveState() {
    localStorage.setItem('stocks', JSON.stringify(stocks));
    localStorage.setItem('liquidity', JSON.stringify(liquidity));
  }

  // Formatting
  function fmtDollar(cents) {
    return (cents / 100).toFixed(2);
  }

  function fmtPct(pct) {
    return pct.toFixed(2) + '%';
  }

  function currSym(currency) {
    return CURRENCY_SYMBOLS[currency] || currency;
  }

  // Convert dollar input to cents
  function dollarsToCents(dollars) {
    return Math.round(dollars * 100);
  }

  // Frankfurter API
  async function fetchRates() {
    const nonUsd = CURRENCIES.filter(c => c !== 'USD');
    if (nonUsd.length === 0) return;
    try {
      const resp = await fetch(`https://api.frankfurter.dev/v1/latest?base=USD&symbols=${nonUsd.join(',')}`);
      if (!resp.ok) throw new Error('API error');
      const data = await resp.json();
      // Frankfurter returns rates FROM base, e.g. { EUR: 0.846 } meaning 1 USD = 0.846 EUR
      // We need "how many USD is 1 unit of currency", so we invert
      for (const c of nonUsd) {
        if (data.rates[c]) {
          rates[c] = +(1 / data.rates[c]).toFixed(6);
        }
      }
      renderInputs();
      calculate();
      const ts = document.getElementById('rates-timestamp');
      ts.textContent = 'ECB ' + data.date;
      showToast('Exchange rates updated');
    } catch (e) {
      showToast('Failed to fetch rates');
    }
  }

  // Export/Import via URL hash
  function exportConfig() {
    const config = { assets, rates };
    const json = JSON.stringify(config);
    const encoded = btoa(unescape(encodeURIComponent(json)));
    const url = window.location.origin + window.location.pathname + '#config=' + encoded;
    navigator.clipboard.writeText(url).then(() => {
      showToast('Link copied to clipboard');
    }).catch(() => {
      prompt('Copy this link:', url);
    });
  }

  function importFromHash() {
    const hash = window.location.hash;
    if (!hash.startsWith('#config=')) return false;
    try {
      const encoded = hash.slice(8);
      const json = decodeURIComponent(escape(atob(encoded)));
      const config = JSON.parse(json);
      if (config.assets && Array.isArray(config.assets)) assets = config.assets;
      if (config.rates && typeof config.rates === 'object') rates = config.rates;
      // Clear hash after import
      history.replaceState(null, '', window.location.pathname);
      showToast('Config imported from link');
      return true;
    } catch {
      return false;
    }
  }

  // Render inputs
  function renderInputs() {
    const abody = document.getElementById('assets-body');
    abody.innerHTML = assets.map((a, i) => `
      <tr>
        <td><span class="ticker">${a.ticker}</span></td>
        <td class="editable">
          <input type="number" data-field="split" data-idx="${i}" value="${a.split}" step="1" min="0" max="100">
        </td>
        <td class="editable">
          <input type="number" data-field="price" data-idx="${i}" value="${a.price}" step="0.01" min="0">
        </td>
        <td><span class="currency-badge">${a.currency}</span></td>
        <td class="editable">
          <input type="number" data-field="holdings" data-idx="${i}" value="${stocks[a.ticker] || 0}" step="1" min="0">
        </td>
      </tr>
    `).join('');

    const rbody = document.getElementById('rates-body');
    rbody.innerHTML = CURRENCIES.map(c => `
      <tr>
        <td><span class="currency-badge">${c}</span></td>
        <td class="editable">
          <input type="number" data-field="rate" data-currency="${c}" value="${rates[c]}" step="0.0001" min="0">
        </td>
      </tr>
    `).join('');

    const lbody = document.getElementById('liquidity-body');
    lbody.innerHTML = CURRENCIES.map(c => `
      <tr>
        <td><span class="currency-badge">${currSym(c)} ${c}</span></td>
        <td class="editable">
          <input type="number" data-field="liquidity" data-currency="${c}" value="${liquidity[c] || 0}" step="0.01" min="0">
        </td>
      </tr>
    `).join('');

    abody.querySelectorAll('input').forEach(el => el.addEventListener('input', onAssetInput));
    rbody.querySelectorAll('input').forEach(el => el.addEventListener('input', onRateInput));
    lbody.querySelectorAll('input').forEach(el => el.addEventListener('input', onLiquidityInput));
  }

  function onAssetInput(e) {
    const { field, idx } = e.target.dataset;
    const val = e.target.value;
    if (field === 'split') assets[idx].split = parseFloat(val) || 0;
    else if (field === 'price') assets[idx].price = parseFloat(val) || 0;
    else if (field === 'holdings') {
      stocks[assets[idx].ticker] = parseInt(val) || 0;
      saveState();
    }
    calculate();
  }

  function onRateInput(e) {
    rates[e.target.dataset.currency] = parseFloat(e.target.value) || 0;
    calculate();
  }

  function onLiquidityInput(e) {
    liquidity[e.target.dataset.currency] = parseFloat(e.target.value) || 0;
    saveState();
    calculate();
  }

  // Donut chart helper
  function renderDonut(el, segments) {
    // segments: [{ pct, color }]
    let acc = 0;
    const stops = [];
    for (const seg of segments) {
      stops.push(`${seg.color} ${acc}deg ${acc + seg.pct * 3.6}deg`);
      acc += seg.pct * 3.6;
    }
    if (acc < 360) {
      stops.push(`var(--surface-3) ${acc}deg 360deg`);
    }
    el.style.background = `conic-gradient(${stops.join(', ')})`;
  }

  // Calculate & render
  function calculate() {
    const validation = document.getElementById('validation');
    const totalSplit = assets.reduce((s, a) => s + a.split, 0);

    if (Math.abs(totalSplit - 100) > 0.001) {
      validation.textContent = `Split must sum to 100% — currently ${totalSplit.toFixed(1)}%`;
      validation.classList.add('visible');
    } else {
      validation.classList.remove('visible');
    }

    // All internal calculations in cents
    let totalValueCents = 0;

    for (const c of CURRENCIES) {
      totalValueCents += dollarsToCents(liquidity[c] || 0) * (rates[c] || 0);
    }

    const stockValues = {};
    for (const a of assets) {
      const priceCents = dollarsToCents(a.price);
      const val = (stocks[a.ticker] || 0) * priceCents * (rates[a.currency] || 0);
      stockValues[a.ticker] = val;
      totalValueCents += val;
    }

    totalValueCents = Math.floor(totalValueCents);

    document.getElementById('total-value').textContent = fmtDollar(totalValueCents);

    // Target values
    const targetValues = {};
    document.getElementById('target-body').innerHTML = assets.map(a => {
      const target = totalValueCents * (a.split / 100);
      targetValues[a.ticker] = target;
      return `<tr><td><span class="ticker">${a.ticker}</span></td><td class="mono">$${fmtDollar(target)}</td></tr>`;
    }).join('');

    // Stock values
    document.getElementById('stock-values-body').innerHTML = assets.map(a =>
      `<tr><td><span class="ticker">${a.ticker}</span></td><td class="mono">$${fmtDollar(stockValues[a.ticker])}</td></tr>`
    ).join('');

    // Liquidity values
    document.getElementById('liquidity-values-body').innerHTML = CURRENCIES.map(c => {
      const val = dollarsToCents(liquidity[c] || 0) * (rates[c] || 0);
      return `<tr><td><span class="currency-badge">${currSym(c)} ${c}</span></td><td class="mono">$${fmtDollar(val)}</td></tr>`;
    }).join('');

    // Percentages
    const stockPortfolioValue = Object.values(stockValues).reduce((s, v) => s + v, 0);

    document.getElementById('pct-total-body').innerHTML = assets.map(a => {
      const pct = totalValueCents > 0 ? (stockValues[a.ticker] / totalValueCents) * 100 : 0;
      const diff = pct - a.split;
      const cls = Math.abs(diff) > 2 ? (diff > 0 ? 'pct-over' : 'pct-under') : '';
      return `<tr>
        <td><span class="ticker">${a.ticker}</span></td>
        <td class="pct-cell">
          <div class="pct-bar" style="width: ${Math.min(pct, 100)}%"></div>
          <span class="pct-text mono ${cls}">${fmtPct(pct)}</span>
        </td>
      </tr>`;
    }).join('');

    document.getElementById('pct-stock-body').innerHTML = assets.map(a => {
      const pct = stockPortfolioValue > 0 ? (stockValues[a.ticker] / stockPortfolioValue) * 100 : 0;
      const diff = pct - a.split;
      const cls = Math.abs(diff) > 2 ? (diff > 0 ? 'pct-over' : 'pct-under') : '';
      return `<tr>
        <td><span class="ticker">${a.ticker}</span></td>
        <td class="pct-cell">
          <div class="pct-bar" style="width: ${Math.min(pct, 100)}%"></div>
          <span class="pct-text mono ${cls}">${fmtPct(pct)}</span>
        </td>
      </tr>`;
    }).join('');

    // Donut charts
    const currentSegments = assets.map((a, i) => ({
      pct: stockPortfolioValue > 0 ? (stockValues[a.ticker] / stockPortfolioValue) * 100 : 0,
      color: CHART_COLORS[i % CHART_COLORS.length],
    }));
    const targetSegments = assets.map((a, i) => ({
      pct: a.split,
      color: CHART_COLORS[i % CHART_COLORS.length],
    }));

    renderDonut(document.getElementById('donut-current'), currentSegments);
    renderDonut(document.getElementById('donut-target'), targetSegments);

    document.getElementById('chart-legend').innerHTML = assets.map((a, i) =>
      `<span class="legend-item"><span class="legend-dot" style="background:${CHART_RAW[i % CHART_RAW.length]}"></span>${a.ticker}</span>`
    ).join('');

    // Advice
    document.getElementById('advice-card').innerHTML = assets.map(a => {
      const current = stockValues[a.ticker];
      const target = targetValues[a.ticker];
      const diff = target - current;
      const priceCentsUsd = dollarsToCents(a.price) * (rates[a.currency] || 0);
      const shares = priceCentsUsd > 0 ? diff / priceCentsUsd : 0;

      if (Math.abs(diff) < 1) {
        return `<div class="advice-row">
          <span class="ticker">${a.ticker}</span>
          <span class="advice-action balanced">Balanced</span>
          <span class="advice-detail">No action needed</span>
        </div>`;
      } else if (diff > 0) {
        return `<div class="advice-row buy-row">
          <span class="ticker">${a.ticker}</span>
          <span class="advice-action buy">Buy</span>
          <span class="advice-detail"><strong>${shares.toFixed(2)}</strong> shares for <strong>$${fmtDollar(diff)}</strong></span>
        </div>`;
      } else {
        return `<div class="advice-row sell-row">
          <span class="ticker">${a.ticker}</span>
          <span class="advice-action sell">Sell</span>
          <span class="advice-detail"><strong>${(-shares).toFixed(2)}</strong> shares for <strong>$${fmtDollar(-diff)}</strong></span>
        </div>`;
      }
    }).join('');
  }

  // Event listeners
  document.getElementById('btn-export').addEventListener('click', exportConfig);
  document.getElementById('btn-refresh-rates').addEventListener('click', fetchRates);

  // Init
  loadState();
  importFromHash();
  renderInputs();
  calculate();
  fetchRates();
</script>

</body>
</html>
